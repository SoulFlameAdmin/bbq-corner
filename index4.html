<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Corner BBQ — Админ</title>
<style>
:root{
  --bg:#0e0f10; --soft:#ffffff1a; --accent:#ff7a00; --text:#fff;
  --card:#121316; --muted:#1a1c20; --danger:#ff3b30; --danger-2:#ff3b301a;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.wrap{max-width:1400px;margin:0 auto;padding:18px}

/* Хедър */
.header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap}
.title{font-weight:900;font-size:20px;color:var(--accent)}
.header-right{display:flex;gap:10px;align-items:center}
.small{font-size:12px;opacity:.75}
.stat{padding:6px 10px;border-radius:10px;background:var(--card);border:1px solid var(--soft);font-weight:800}
.filter{display:flex;gap:6px;align-items:center}
.filter select, .filter input{
  background:var(--card);border:1px solid var(--soft);color:#fff;border-radius:10px;padding:6px 10px;outline:none
}

/* Лейаут: Сайдбар + Активни */
.main{display:grid;grid-template-columns:320px 1fr;gap:16px}
@media (max-width:1100px){.main{grid-template-columns:1fr}}
/* Сайдбар */
.sidebar{
  background:var(--card);border:1px solid var(--soft);border-radius:16px;padding:12px;max-height:calc(100dvh - 140px);overflow:auto;
}
.sidebar h3{font-size:14px;margin-bottom:8px;opacity:.9}
.day{border:1px solid var(--soft);background:#0f1013;border-radius:12px;margin-bottom:8px;overflow:hidden}
.day summary{cursor:pointer;list-style:none;padding:10px 12px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
.day summary::-webkit-details-marker{display:none}
.day .list{border-top:1px dashed var(--soft)}
.done-item{display:flex;justify-content:space-between;gap:10px;padding:8px 12px;border-top:1px dashed #ffffff12}
.done-item:hover{background:#ffffff06}
.tag{font-size:12px;opacity:.8}
.btn-restore{
  background:#181a1f;border:1px solid var(--soft);color:#fff;border-radius:999px;padding:4px 8px;font-weight:800;cursor:pointer
}
.total-line{font-weight:900}

/* Активни поръчки */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:1280px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:700px){.grid{grid-template-columns:1fr}}

.card{
  background:var(--card);border:1px solid var(--soft);border-radius:16px;padding:14px;box-shadow:0 8px 28px rgba(0,0,0,.28);
  position:relative;overflow:hidden
}
.card.new::after{
  content:'';position:absolute;inset:0;border-radius:16px;pointer-events:none;
  box-shadow:0 0 0 2px var(--accent),0 0 24px 6px rgba(255,122,0,.35);animation:glow 1.8s ease-in-out 2
}
@keyframes glow{0%,100%{opacity:0}50%{opacity:1}}
.row{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:999px;background:var(--muted);border:1px solid var(--soft);font-size:12px;font-weight:800}
.status{padding:4px 10px;border-radius:10px;font-size:12px;font-weight:900;background:var(--muted);border:1px solid var(--soft)}
.status[data-s='ПРЕГЛЕД']{color:#f0f0f0}
.status[data-s='ПРИГОТВЯ СЕ']{background:#1e2a18;color:#95ff6b;border-color:#2c4a23}
.status[data-s='ДОСТАВЯ СЕ']{background:#262017;color:#ffcf7a;border-color:#554125}
.items{margin-top:8px;border-top:1px dashed var(--soft);padding-top:8px}
.item{display:flex;justify-content:space-between;margin:4px 0;font-size:14px}
.total{margin-top:10px;font-weight:900;display:flex;justify-content:flex-end}
.addr{margin-top:6px;font-size:14px;opacity:.95}
.btns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn{
  background:#181a1f;border:1px solid var(--soft);color:#fff;border-radius:10px;padding:8px 10px;font-weight:800;
  cursor:pointer
}
.btn:hover{border-color:#ffffff33}
.btn-done{
  background:var(--danger-2);border:1px solid #ff594f;color:#ffd9d7;
}
.btn-done:hover{background:#ff3b3026;border-color:var(--danger);color:#fff}

/* Празно състояние */
.empty{padding:20px;text-align:center;border:1px dashed var(--soft);border-radius:12px;margin-top:8px}

/* Toast */
.toast{
  position:fixed;right:16px;bottom:16px;max-width:380px;background:var(--card);border:1px solid var(--soft);
  padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.4);z-index:50
}
.toast .h{font-weight:900;margin-bottom:6px}
.toast .a{opacity:.9;font-size:14px;margin-top:6px}
.toast .row{justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">Админ панел — Поръчки</div>
    <div class="header-right">
      <div class="filter">
        <select id="statusFilter" title="Филтър по статус">
          <option value="ALL">Всички</option>
          <option value="ПРЕГЛЕД">ПРЕГЛЕД</option>
          <option value="ПРИГОТВЯ СЕ">ПРИГОТВЯ СЕ</option>
          <option value="ДОСТАВЯ СЕ">ДОСТАВЯ СЕ</option>
        </select>
        <input id="searchBox" type="search" placeholder="Търси по име/телефон/адрес…">
      </div>
      <div class="stat"><span id="count">0</span> поръчки</div>
      <div class="stat">Общо: <span id="sum">0,00 лв.</span></div>
    </div>
  </div>

  <div class="main">
    <!-- Сайдбар: Изпълнени -->
    <aside class="sidebar">
      <h3>✅ Изпълнени поръчки</h3>
      <div id="doneContainer"></div>
      <div id="doneEmpty" class="empty" style="display:none">Няма изпълнени поръчки.</div>
    </aside>

    <!-- Активни -->
    <section>
      <div class="grid" id="grid"></div>
      <div id="emptyState" class="empty" style="display:none">Няма активни поръчки.</div>
    </section>
  </div>
</div>

<div id="toast" class="toast" style="display:none">
  <div class="h" id="toastTitle">Детайли</div>
  <div class="a" id="toastBody"></div>
  <div class="row">
    <button class="btn btn-restore" id="toastRestore" style="display:none">Върни в активни</button>
    <button class="btn" id="toastClose">Затвори</button>
  </div>
</div>

<script type="module">
/* ===== 0) Лека защита ===== */
(function enforceAdmin(){
  try{
    const ok = sessionStorage.getItem('bbq_is_admin') === '1';
    if(!ok){
      const target = (location.protocol === 'file:') ? 'file:///E:/BBQ_SITE/index.html' : 'index.html';
      // window.location.href = target; // отключи при нужда
    }
  }catch(_){}
})();

/* ===== 1) Помощни ===== */
const lv = n => (Number(n)||0).toFixed(2).replace('.',',')+' лв.';
const fmtWhen = ts => {
  try{
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString();
  }catch(_){ return ''; }
};
const ymd = d => {
  const dt = d instanceof Date ? d : (d?.toDate ? d.toDate() : new Date(d));
  const yy = dt.getFullYear(), mm = String(dt.getMonth()+1).padStart(2,'0'), dd = String(dt.getDate()).padStart(2,'0');
  return `${yy}-${mm}-${dd}`;
};
const hh = d => {
  const dt = d instanceof Date ? d : (d?.toDate ? d.toDate() : new Date(d));
  return String(dt.getHours()).padStart(2,'0');
};

function escapeHTML(s){
  return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}

/* DOM refs */
const grid   = document.getElementById('grid');
const countE = document.getElementById('count');
const sumE   = document.getElementById('sum');
const emptyE = document.getElementById('emptyState');
const selStatus = document.getElementById('statusFilter');
const searchBox = document.getElementById('searchBox');

const doneWrap = document.getElementById('doneContainer');
const doneEmpty = document.getElementById('doneEmpty');

const toast = document.getElementById('toast');
const toastTitle = document.getElementById('toastTitle');
const toastBody = document.getElementById('toastBody');
const toastClose = document.getElementById('toastClose');
const toastRestore = document.getElementById('toastRestore');
toastClose.onclick = ()=> toast.style.display='none';

/* ===== 2) Firebase ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import {
  getFirestore, collection, query, orderBy, onSnapshot,
  doc, updateDoc, getDoc, setDoc, deleteDoc, serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyAhaEPIEODEoRiwTulBw4W9YTXyMW9sqKg",
  authDomain: "corner-bbq.firebaseapp.com",
  projectId: "corner-bbq",
  storageBucket: "corner-bbq.firebasestorage.app",
  messagingSenderId: "878314744141",
  appId: "1:878314744141:web:f869886ee4380e9dbcaf04",
  measurementId: "G-FWBDL96GN0"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== 3) Реално време: активни поръчки ===== */
let orders = []; // Firestore → 'orders'
const qActive = query(collection(db, 'orders'), orderBy('createdAt','desc'));

onSnapshot(qActive, (snap)=>{
  const nextNew = [];
  const seenIds = new Set(orders.map(o=>o.id));
  snap.docChanges().forEach(ch=>{
    if (ch.type === 'added' && !seenIds.has(ch.doc.id)){
      nextNew.push({ id: ch.doc.id, _new: true });
    }
  });

  orders = snap.docs.map(d => {
    const wasNew = nextNew.find(x=>x.id===d.id)?._new : false;
    return { id: d.id, _new: wasNew, ...d.data() };
  });

  renderActive();
});

/* ===== 4) Реално време: изпълнени поръчки (sidebar) ===== */
let doneOrders = []; // Firestore → 'orders_completed'
const qDone = query(collection(db, 'orders_completed'), orderBy('completedAt','desc'));

onSnapshot(qDone, (snap)=>{
  doneOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderDoneSidebar();
});

/* ===== 5) Рендер на активните + филтри ===== */
selStatus.addEventListener('change', renderActive);
searchBox.addEventListener('input', renderActive);

function renderActive(){
  const fStatus = selStatus.value;
  const qtext = (searchBox.value || '').trim().toLowerCase();

  let filtered = orders.slice();
  if (fStatus !== 'ALL'){
    filtered = filtered.filter(o => (o.status||'') === fStatus);
  }
  if (qtext){
    filtered = filtered.filter(o=>{
      const c = o.customer || {};
      const hay = [c.names, c.phone, c.address].join(' ').toLowerCase();
      return hay.includes(qtext);
    });
  }

  countE.textContent = String(filtered.length);
  const totalSum = filtered.reduce((s,o)=> s + (Number(o.total)||0), 0);
  sumE.textContent = lv(totalSum);
  emptyE.style.display = filtered.length ? 'none' : 'block';

  grid.innerHTML = filtered.map(o=>{
    const when = fmtWhen(o.createdAt);
    const items = Array.isArray(o.items) ? o.items : [];
    const status = o.status || 'ПРЕГЛЕД';
    return `
    <div class="card ${o._new ? 'new':''}" data-id="${o.id}">
      <div class="row" style="justify-content:space-between;">
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="badge">#${o.id.slice(0,6)}</span>
          <span class="small">${when}</span>
          <span class="status" data-s="${status}">${status}</span>
        </div>
        <button class="btn btn-done" title="Маркирай като изпълнена" data-id="${o.id}">❌ Готово</button>
      </div>
      <div class="row"><strong>${escapeHTML(o.customer?.names||'')}</strong> &nbsp; <span class="small">(${escapeHTML(o.customer?.phone||'')})</span></div>
      <div class="addr">📍 ${escapeHTML(o.customer?.address||'')}</div>
      <div class="items">
        ${items.map(it=>`<div class="item"><span>${escapeHTML(it.name||'')}</span><span>${lv(Number(it.price)||0)}</span></div>`).join('')}
      </div>
      <div class="total">Общо: ${lv(Number(o.total)||0)}</div>
      <div class="btns">
        <button class="btn btn-prev" data-id="${o.id}">ПРЕГЛЕД</button>
        <button class="btn btn-cook" data-id="${o.id}">ПРИГОТВЯ СЕ</button>
        <button class="btn btn-deliver" data-id="${o.id}">ДОСТАВЯ СЕ</button>
      </div>
    </div>`;
  }).join('');

  bindButtons();
  orders = orders.map(o => ({...o, _new:false}));
}

function bindButtons(){
  grid.querySelectorAll('.btn-prev').forEach(b=>b.addEventListener('click', ()=> setStatus(b.dataset.id,'ПРЕГЛЕД')));
  grid.querySelectorAll('.btn-cook').forEach(b=>b.addEventListener('click', ()=> setStatus(b.dataset.id,'ПРИГОТВЯ СЕ')));
  grid.querySelectorAll('.btn-deliver').forEach(b=>b.addEventListener('click', ()=> setStatus(b.dataset.id,'ДОСТАВЯ СЕ')));
  grid.querySelectorAll('.btn-done').forEach(b=>b.addEventListener('click', ()=> completeOrder(b.dataset.id)));
}

async function setStatus(id, status){
  try{
    const ref = doc(db, 'orders', id);
    await updateDoc(ref, { status });
    const el = grid.querySelector(`.card[data-id="${id}"] .status`);
    if (el){ el.textContent = status; el.setAttribute('data-s', status); }
  }catch(err){
    console.error(err);
    alert('Неуспешна промяна на статуса. Проверете връзката.');
  }
}

/* ===== 6) Маркиране като изпълнена (преместване) ===== */
async function completeOrder(id){
  try{
    // 1) Вземи текущата поръчка
    const srcRef = doc(db, 'orders', id);
    const snap = await getDoc(srcRef);
    if (!snap.exists()){
      alert('Поръчката не съществува.');
      return;
    }
    const data = snap.data();

    // 2) Обогати с полета за завършване
    const now = new Date();
    const payload = {
      ...data,
      originalId: id,
      completedAt: serverTimestamp(),
      dayKey: ymd(now),
      hourKey: hh(now)
    };

    // 3) Запиши в orders_completed със същото id (лесна корелация)
    const dstRef = doc(db, 'orders_completed', id);
    await setDoc(dstRef, payload, { merge: true });

    // 4) Изтрий от активните
    await deleteDoc(srcRef);

    // 5) Лек тост
    showToast('Поръчка изпълнена', `Преместена е в „Изпълнени“. Клиент: <b>${escapeHTML(data?.customer?.names||'')}</b>, Общо: <b>${lv(Number(data?.total)||0)}</b>`);
  }catch(err){
    console.error(err);
    alert('Грешка при финализиране на поръчката.');
  }
}

/* ===== 7) Рендер на „Изпълнени“ в сайдбар (групиране по дни/часове) ===== */
function renderDoneSidebar(){
  if (!doneOrders.length){
    doneWrap.innerHTML = '';
    doneEmpty.style.display = 'block';
    return;
  }
  doneEmpty.style.display = 'none';

  // групирай по dayKey
  const groups = {};
  for (const o of doneOrders){
    const d = o.dayKey || ymd(o.completedAt || o.createdAt || new Date());
    if (!groups[d]) groups[d] = [];
    groups[d].push(o);
  }
  // сортирай дните низходящо
  const days = Object.keys(groups).sort((a,b)=> b.localeCompare(a));
  const html = days.map(day=>{
    const list = groups[day].sort((a,b)=>{
      const ad = a.completedAt?.toMillis ? a.completedAt.toMillis() : (a.completedAt ? +new Date(a.completedAt) : 0);
      const bd = b.completedAt?.toMillis ? b.completedAt.toMillis() : (b.completedAt ? +new Date(b.completedAt) : 0);
      return bd - ad;
    });
    const sum = list.reduce((s,o)=> s + (Number(o.total)||0), 0);
    return `
    <details class="day" ${days.indexOf(day)===0?'open':''}>
      <summary>
        <span>${day}</span>
        <span class="tag">${list.length} бр. • ${lv(sum)}</span>
      </summary>
      <div class="list">
        ${list.map(o=>{
          const t = o.completedAt ? fmtWhen(o.completedAt) : (o.createdAt ? fmtWhen(o.createdAt) : '');
          const timeOnly = t.split(', ').pop() || t;
          return `
            <div class="done-item" data-id="${o.id}">
              <div>
                <div><b>${escapeHTML(o.customer?.names||'')}</b> <span class="tag">(${escapeHTML(o.customer?.phone||'')})</span></div>
                <div class="tag">🕒 ${escapeHTML(timeOnly)} • 📍 ${escapeHTML(o.customer?.address||'')}</div>
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
                <div class="total-line">${lv(Number(o.total)||0)}</div>
                <button class="btn-restore" data-id="${o.id}">Върни</button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </details>`;
  }).join('');

  doneWrap.innerHTML = html;

  // обработчици
  doneWrap.querySelectorAll('.done-item').forEach(el=>{
    el.addEventListener('click', (e)=>{
      if (e.target && e.target.classList.contains('btn-restore')) return; // отделно за restore
      const id = el.dataset.id;
      const o = doneOrders.find(x=>x.id===id);
      if (o) openDoneToast(o);
    });
  });
  doneWrap.querySelectorAll('.btn-restore').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      restoreToActive(btn.dataset.id);
    });
  });
}

/* ===== 8) Restore (по желание) ===== */
async function restoreToActive(id){
  try{
    const srcRef = doc(db, 'orders_completed', id);
    const snap = await getDoc(srcRef);
    if (!snap.exists()){
      alert('Липсва запис в „Изпълнени“.');
      return;
    }
    const data = snap.data();
    const payload = {
      ...data,
      status: data.status || 'ПРЕГЛЕД',
      // махаме служебните ключове от completed
      completedAt: null, dayKey: null, hourKey: null
    };
    const dstRef = doc(db, 'orders', id);
    await setDoc(dstRef, payload, { merge:true });
    await deleteDoc(srcRef);
    showToast('Върната поръчка', `Поръчката #${id.slice(0,6)} е върната сред активните.`);
  }catch(err){
    console.error(err);
    alert('Грешка при връщане на поръчката.');
  }
}

/* ===== 9) Toast helper ===== */
function showToast(title, body, canRestore=false, restoreHandler=null){
  toastTitle.innerHTML = escapeHTML(title);
  toastBody.innerHTML = body;
  toastRestore.style.display = canRestore ? 'inline-flex' : 'none';
  if (canRestore && restoreHandler){
    const cloned = toastRestore.cloneNode(true);
    toastRestore.parentNode.replaceChild(cloned, toastRestore);
    cloned.id = 'toastRestore';
    cloned.onclick = restoreHandler;
  }
  toast.style.display = 'block';
}
function openDoneToast(o){
  const items = Array.isArray(o.items) ? o.items : [];
  const when = o.completedAt ? fmtWhen(o.completedAt) : (o.createdAt ? fmtWhen(o.createdAt) : '');
  const body = `
    <div><b>${escapeHTML(o.customer?.names||'')}</b> (${escapeHTML(o.customer?.phone||'')})</div>
    <div>📍 ${escapeHTML(o.customer?.address||'')}</div>
    <div>🕒 ${escapeHTML(when)}</div>
    <hr style="border:none;border-top:1px dashed #ffffff24;margin:8px 0">
    ${items.map(it=>`<div class="item"><span>${escapeHTML(it.name||'')}</span><span>${lv(Number(it.price)||0)}</span></div>`).join('')}
    <div class="total" style="justify-content:space-between"><span>Общо:</span><span>${lv(Number(o.total)||0)}</span></div>
  `;
  showToast('Изпълнена поръчка', body, true, ()=> restoreToActive(o.id));
}
</script>
</body>
</html>
